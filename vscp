#!/usr/bin/env bash
set -eo pipefail

#####################################
# vscp - Vultr SCP helper
# Usage: vscp <file> <host> [remote_path]
#####################################

usage() {
    echo "Usage: vscp <file> <host> [remote_path]"
    echo ""
    echo "Examples:"
    echo "  vscp ./typescript.sh tiny-box-1765509851"
    echo "  vscp ./typescript.sh tiny-box-1765509851 /root/setup.sh"
    echo "  vscp ./typescript.sh tiny-box-1765509851 --run"
    echo ""
    echo "Options:"
    echo "  --run    Copy and execute the script"
    echo ""
    echo "Available hosts:"
    grep -E "^Host tiny-box-" ~/.ssh/config 2>/dev/null | awk '{print "  " $2}' || echo "  (none found)"
    exit 1
}

if [[ $# -lt 2 ]]; then
    usage
fi

LOCAL_FILE="$1"
HOST="$2"
RUN_AFTER=false

# Check for --run flag
if [[ "$3" == "--run" ]]; then
    RUN_AFTER=true
    REMOTE_PATH="/root/$(basename "$LOCAL_FILE")"
elif [[ -n "$3" ]]; then
    REMOTE_PATH="$3"
else
    REMOTE_PATH="/root/$(basename "$LOCAL_FILE")"
fi

# Validate file exists
if [[ ! -f "$LOCAL_FILE" ]]; then
    echo "âŒ File not found: $LOCAL_FILE"
    exit 1
fi

# Validate host exists in SSH config
if ! grep -qE "^Host $HOST$" ~/.ssh/config 2>/dev/null; then
    echo "âŒ Host '$HOST' not found in ~/.ssh/config"
    echo ""
    echo "Available hosts:"
    grep -E "^Host tiny-box-" ~/.ssh/config 2>/dev/null | awk '{print "  " $2}' || echo "  (none)"
    exit 1
fi

# Copy file
echo "ðŸ“¤ Copying $(basename "$LOCAL_FILE") â†’ $HOST:$REMOTE_PATH"
scp "$LOCAL_FILE" "$HOST:$REMOTE_PATH"
echo "âœ… Copied!"

# Run if requested
if [[ "$RUN_AFTER" == true ]]; then
    echo "ðŸš€ Running $(basename "$LOCAL_FILE") on $HOST..."
    echo "==============================="
    ssh "$HOST" "chmod +x $REMOTE_PATH && $REMOTE_PATH"
fi
